<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hall Chat</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    /* Original CSS */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      background-color: #f0f2f5;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background-color: #ffffff;
      padding: 15px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .version {
      font-size: 0.5em;
      color: #666;
    }
    .container {
      flex: 1;
      display: flex;
      max-width: 1800px;
      margin: 20px auto;
      gap: 20px;
      padding: 0 20px;
    }
    .rooms-sidebar {
      width: 300px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 15px;
    }
    .rooms-list {
      margin-top: 15px;
    }
    .room-item {
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
    }
    .room-item:hover {
      background-color: #f0f2f5;
    }
    .room-item.active {
      background-color: #e3f2fd;
    }
    .room-item i {
      color: #666;
    }
    .notification-dot {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background-color: #0084ff;
      border-radius: 50%;
      display: none;
    }
    .room-item.has-notification .notification-dot {
      display: block;
    }
    .chat-container {
      flex: 1;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .chat-header {
      padding: 15px;
      border-bottom: 1px solid #e4e6eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .refresh-btn {
      background-color: #ff4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      display: none;
      font-size: 0.9em;
    }
    .refresh-btn.visible {
      display: block;
    }
    .refresh-btn:hover {
      background-color: #cc0000;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .message {
      margin-bottom: 15px;
      max-width: 70%;
      position: relative;
    }
    .message.sent {
      margin-left: auto;
    }
    .message-content {
      padding: 10px 15px;
      border-radius: 15px;
      background-color: #f0f2f5;
    }
    .message.sent .message-content {
      background-color: #0084ff;
      color: white;
    }
    .message-username {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
      justify-content: space-between;
    }
    .message-time {
      font-size: 0.7em;
      color: #999;
    }
    .message-actions {
      display: flex;
      gap: 5px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .message:hover .message-actions {
      opacity: 1;
    }
    .delete-btn {
      color: #ff4444;
      cursor: pointer;
      font-size: 0.8em;
    }
    .delete-btn:hover {
      color: #cc0000;
    }
    .room-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .delete-room-btn {
      color: #ff4444;
      cursor: pointer;
      font-size: 0.9em;
      display: none;
      margin-left: 10px;
    }
    .room-item:hover .delete-room-btn {
      display: inline-block;
    }
    .verified-badge {
      color: #0084ff;
      margin-left: 5px;
      display: inline-block;
    }
    .input-area {
      padding: 20px;
      border-top: 1px solid #e4e6eb;
      display: flex;
      gap: 10px;
    }
    .input-area input {
      flex: 1;
      padding: 12px;
      border: 1px solid #e4e6eb;
      border-radius: 20px;
      outline: none;
    }
    .input-area button {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background-color: #0084ff;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .input-area button:hover {
      background-color: #0073e6;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
    }
    .modal-content input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
      border: 1px solid #e4e6eb;
      border-radius: 5px;
    }
    .modal-content button {
      width: 100%;
      padding: 10px;
      background-color: #0084ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }
    .create-room-btn {
      width: 100%;
      padding: 10px;
      background-color: #0084ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    .chat-windows {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      flex: 1;
      padding: 20px;
      height: calc(100vh - 100px);
      overflow-y: auto;
    }
    .chat-window {
      min-width: 400px;
      max-width: none;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      position: relative;
      height: 100%;
      overflow: hidden;
    }
    .close-window {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 1.2em;
      z-index: 1;
    }
    .close-window:hover {
      color: #ff4444;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #e4e6eb;
      background: white;
      border-radius: 10px 10px 0 0;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
    }
    .tab.active {
      border-bottom-color: #0084ff;
      color: #0084ff;
    }
    .dm-list {
      margin-top: 15px;
    }
    .dm-item {
      padding: 10px;
      margin: 5px 0;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .dm-item:hover {
      background-color: #f0f2f5;
    }
    .dm-item.active {
      background-color: #e3f2fd;
    }
    .new-dm-btn {
      width: 100%;
      padding: 10px;
      background-color: #0084ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    .admin-panel {
      position: fixed;
      top: 80px;
      right: 20px;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none;
      z-index: 1000;
    }
    .admin-panel.visible {
      display: block;
    }
    .admin-panel h3 {
      margin-bottom: 10px;
    }
    .admin-panel button {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      background-color: #ff4444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .dm-btn {
      color: #0084ff;
      cursor: pointer;
      font-size: 0.8em;
      margin-left: 5px;
    }
    .dm-btn:hover {
      color: #0073e6;
    }
    .sign-out-btn {
      padding: 8px 16px;
      background-color: #ff4444;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 20px;
    }
    .sign-out-btn:hover {
      background-color: #cc0000;
    }
    .ban-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .ban-modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
    }
    .ban-search {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #e4e6eb;
      border-radius: 5px;
    }
    .ban-list {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 15px;
    }
    .ban-item {
      padding: 8px;
      cursor: pointer;
      border-bottom: 1px solid #e4e6eb;
    }
    .ban-item:hover {
      background-color: #f0f2f5;
    }
    .ban-duration {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .ban-duration input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e4e6eb;
      border-radius: 5px;
    }
    .ban-reason {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #e4e6eb;
      border-radius: 5px;
    }
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #0084ff;
      color: white;
      padding: 15px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    .banned-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .banned-message {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      max-width: 500px;
    }
    .create-room-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 10px 0;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      height: calc(100% - 120px);
    }
    .search-box {
      width: 100%;
      padding: 8px;
      margin-bottom: 15px;
      border: 1px solid #e4e6eb;
      border-radius: 5px;
    }
    .message-checkbox {
      position: absolute;
      left: -25px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
    }
    .message:hover .message-checkbox {
      display: block;
    }
    .message.selected {
      background-color: rgba(0, 132, 255, 0.1);
    }
    .report-btn {
      color: #ff4444;
      cursor: pointer;
      font-size: 0.8em;
      margin-left: 5px;
      display: none;
    }
    .message:hover .report-btn {
      display: inline-block;
    }
    .mass-delete-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #ff4444;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      display: none;
      z-index: 1000;
    }
    .mass-delete-btn.visible {
      display: block;
    }
    .announcement-banner {
      background-color: #ffa500;
      color: white;
      padding: 15px;
      text-align: center;
      position: relative;
      display: none;
    }
    .announcement-banner.visible {
      display: block;
    }
    .announcement-banner .close-btn {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: white;
    }
    .dark-mode {
      background-color: #1a1a1a;
      color: #ffffff;
    }
    .dark-mode .header,
    .dark-mode .chat-container,
    .dark-mode .chat-window,
    .dark-mode .rooms-sidebar,
    .dark-mode .modal-content,
    .dark-mode .admin-panel {
      background-color: #2d2d2d;
      color: #ffffff;
    }
    .dark-mode .message-content {
      background-color: #3d3d3d;
      color: #ffffff;
    }
    .dark-mode .message.sent .message-content {
      background-color: #0084ff;
    }
    .dark-mode .input-area input {
      background-color: #3d3d3d;
      color: #ffffff;
      border-color: #4d4d4d;
    }
    .dark-mode .room-item:hover,
    .dark-mode .dm-item:hover {
      background-color: #3d3d3d;
    }
    .theme-switch {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: none;
      border: none;
      color: #666;
      cursor: pointer;
      font-size: 1.5em;
    }
    .dark-mode .theme-switch {
      color: #ffffff;
    }
    .input-area button i.fa-image {
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Hall Chat <span class="version">Version 1.13</span></h1>
    <button class="theme-switch" onclick="toggleTheme()">🌙</button>
    <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
  </div>
  <div class="container">
    <div class="rooms-sidebar">
      <input type="text" class="search-box" placeholder="Search rooms..." onkeyup="filterRooms(this.value)" />
      <button class="create-room-btn" onclick="showCreateRoomModal()">Create Room</button>
      <div class="rooms-list" id="roomsList">
        <!-- Rooms will be populated here -->
      </div>
    </div>
    <div class="chat-windows" id="chatWindows">
      <!-- Chat windows will be added here -->
    </div>
  </div>
  <!-- Username Modal -->
  <div class="modal" id="usernameModal">
    <div class="modal-content">
      <h2>Enter Your Name</h2>
      <input type="text" id="usernameInput" placeholder="Your name" />
      <button onclick="setUsername()">Start Chatting</button>
    </div>
  </div>
  <!-- Create Room Modal -->
  <div class="modal" id="createRoomModal">
    <div class="modal-content">
      <h2>Create New Room</h2>
      <div class="create-room-checkbox">
        <input type="text" id="roomNameInput" placeholder="Room name" />
        <label>
          <input type="checkbox" id="isPrivateRoom" /> Private Room
        </label>
      </div>
      <div id="roomPasswordGroup" style="display: none;">
        <input type="password" id="roomPasswordInput" placeholder="Room password" />
      </div>
      <button onclick="createRoom()">Create Room</button>
      <button onclick="hideCreateRoomModal()" style="background-color: #e4e6eb; color: #1a1a1a;">Cancel</button>
    </div>
  </div>
  <!-- Join Private Room Modal -->
  <div class="modal" id="joinPrivateModal">
    <div class="modal-content">
      <h2>Join Private Room</h2>
      <p id="joinRoomName"></p>
      <input type="password" id="joinPasswordInput" placeholder="Enter room password" />
      <button onclick="joinPrivateRoom()">Join Room</button>
      <button onclick="hideJoinPrivateModal()" style="background-color: #e4e6eb; color: #1a1a1a;">Cancel</button>
    </div>
  </div>
  <!-- ABen Verification Modal -->
  <div class="modal" id="abenVerificationModal">
    <div class="modal-content">
      <h2>Verify ABen Account</h2>
      <p>Enter the password to verify your ABen account:</p>
      <input type="password" id="abenPasswordInput" placeholder="Enter password" />
      <button onclick="verifyABen()">Verify</button>
      <button onclick="hideABenVerificationModal()" style="background-color: #e4e6eb; color: #1a1a1a;">Cancel</button>
    </div>
  </div>
  <!-- Insert Image Modal -->
  <div class="modal" id="imageModal">
    <div class="modal-content">
      <h2>Insert Image</h2>
      <input type="text" id="imageURLInput" placeholder="Paste image URL here" />
      <button onclick="sendImageMessage()">Insert Image</button>
      <button onclick="hideImageModal()" style="background-color: #e4e6eb; color: #1a1a1a;">Cancel</button>
    </div>
  </div>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAk0TC8kfFseOJ2pMPyUhCicagtro8HoHA",
      authDomain: "chat-26c4e.firebaseapp.com",
      databaseURL: "https://chat-26c4e-default-rtdb.firebaseio.com",
      projectId: "chat-26c4e",
      storageBucket: "chat-26c4e.firebasestorage.app",
      messagingSenderId: "743283116676",
      appId: "1:743283116676:web:18390431dbe191181750d1"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let username = localStorage.getItem('username');
    let currentRoom = null;
    let isVerifiedABen = localStorage.getItem('isVerifiedABen') === 'true';
    let isVerifiedLizzyBen = localStorage.getItem('isVerifiedLizzyBen') === 'true';
    let unreadMessages = new Set();
    let selectedMessages = new Set();
    let isDarkMode = localStorage.getItem('darkMode') === 'true';
    
    // DOM Elements
    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const usernameModal = document.getElementById('usernameModal');
    const usernameInput = document.getElementById('usernameInput');
    const roomsList = document.getElementById('roomsList');
    const createRoomModal = document.getElementById('createRoomModal');
    const joinPrivateModal = document.getElementById('joinPrivateModal');
    const abenVerificationModal = document.getElementById('abenVerificationModal');
    const isPrivateRoomCheckbox = document.getElementById('isPrivateRoom');
    const roomPasswordGroup = document.getElementById('roomPasswordGroup');
    const adminPanel = document.getElementById('adminPanel');
    
    // Global variable to track which chat window is sending an image
    let currentChatWindowForImage = null;
    
    if (!username) {
      usernameModal.style.display = 'flex';
    } else {
      loadRooms();
    }
    loadRooms();
    
    const MAX_USERNAME_LENGTH = 20;
    const MAX_MESSAGE_LENGTH = 100;
    const MAX_ROOM_NAME_LENGTH = 30;
    const MAX_SEARCH_LENGTH = 50;
    const MAX_MESSAGES_PER_ROOM = 50;
    
    function setUsername() {
      const newUsername = usernameInput.value.trim();
      if (!newUsername) return;
      if (newUsername.length > MAX_USERNAME_LENGTH) {
        alert(`Username must be ${MAX_USERNAME_LENGTH} characters or less`);
        return;
      }
      // For ABen or LizzyBen, show the verification modal
      if (newUsername === 'ABen' || newUsername === 'LizzyBen') {
        username = newUsername;
        localStorage.setItem('username', username);
        usernameModal.style.display = 'none';
        abenVerificationModal.style.display = 'flex';
        return;
      }
      username = newUsername;
      localStorage.setItem('username', username);
      usernameModal.style.display = 'none';
      loadRooms();
    }
    
    // New verification function for ABen and LizzyBen accounts.
    // For demonstration, the verification passwords are:
    // - ABen: "ABenSecret"
    // - LizzyBen: "LizzySecret"
    function verifyABen() {
      const passwordInput = document.getElementById('abenPasswordInput').value.trim();
      if ((username === 'ABen' && passwordInput === 'ABenSecret') ||
          (username === 'LizzyBen' && passwordInput === 'LizzySecret')) {
        if (username === 'ABen') {
          localStorage.setItem('isVerifiedABen', 'true');
          isVerifiedABen = true;
        } else {
          localStorage.setItem('isVerifiedLizzyBen', 'true');
          isVerifiedLizzyBen = true;
        }
        abenVerificationModal.style.display = 'none';
        loadRooms();
      } else {
        alert('Incorrect verification password.');
      }
    }
    
    function hideABenVerificationModal() {
      abenVerificationModal.style.display = 'none';
      username = null;
      localStorage.removeItem('username');
      usernameModal.style.display = 'flex';
    }
    
    function showCreateRoomModal() {
      createRoomModal.style.display = 'flex';
    }
    function hideCreateRoomModal() {
      createRoomModal.style.display = 'none';
    }
    function hideJoinPrivateModal() {
      joinPrivateModal.style.display = 'none';
      currentRoom = null;
    }
    
    isPrivateRoomCheckbox.addEventListener('change', () => {
      roomPasswordGroup.style.display = isPrivateRoomCheckbox.checked ? 'block' : 'none';
    });
    
    function createRoom() {
      const roomName = document.getElementById('roomNameInput').value.trim();
      const isPrivate = isPrivateRoomCheckbox.checked;
      const password = isPrivate ? document.getElementById('roomPasswordInput').value : null;
      if (!roomName) return;
      if (roomName.length > MAX_ROOM_NAME_LENGTH) {
        alert(`Room name must be ${MAX_ROOM_NAME_LENGTH} characters or less`);
        return;
      }
      database.ref('rooms').push({
        name: roomName,
        isPrivate: isPrivate,
        password: password,
        createdBy: username,
        timestamp: Date.now()
      });
      hideCreateRoomModal();
      loadRooms();
    }
    
    function loadRooms() {
      database.ref('rooms').once('value').then((snapshot) => {
        roomsList.innerHTML = '';
        snapshot.forEach((childSnapshot) => {
          const room = childSnapshot.val();
          room.key = childSnapshot.key;
          const roomElement = createRoomElement(room);
          roomsList.appendChild(roomElement);
        });
      });
    }
    
    function createRoomElement(room) {
      const div = document.createElement('div');
      div.className = 'room-item';
      if (unreadMessages.has(room.key)) {
        div.classList.add('has-notification');
      }
      const deleteButton = (isVerifiedABen || isVerifiedLizzyBen)
        ? `<span class="delete-room-btn" onclick="event.stopPropagation(); deleteRoom('${room.key}')">
             <i class="fas fa-trash"></i>
           </span>`
        : '';
      div.innerHTML = `
        <span>
          <i class="fas ${room.isPrivate ? 'fa-lock' : 'fa-comments'}"></i>
          ${room.name}
        </span>
        ${deleteButton}
        <div class="notification-dot"></div>
      `;
      div.onclick = () => joinRoom(room);
      return div;
    }
    
    function joinRoom(room) {
      if (activeChats.some(chat => chat.type === 'group' && chat.room.key === room.key)) {
        return;
      }
      if (room.isPrivate) {
        currentRoom = room;
        document.getElementById('joinRoomName').textContent = `Enter password for ${room.name}`;
        joinPrivateModal.style.display = 'flex';
        return;
      }
      if (activeChats.length >= MAX_CHATS) {
        alert('Maximum number of chats reached!');
        return;
      }
      unreadMessages.delete(room.key);
      const roomElement = document.querySelector(`.room-item[data-room-key="${room.key}"]`);
      if (roomElement) {
        roomElement.classList.remove('has-notification');
      }
      const chatWindow = document.createElement('div');
      chatWindow.className = 'chat-window';
      chatWindow.innerHTML = `
        <button class="close-window" onclick="closeChatWindow(this)">×</button>
        <div class="chat-header">
          <h2>${room.name}</h2>
          <button class="refresh-btn" onclick="refreshRoom('${room.key}')">Refresh</button>
        </div>
        <div class="messages"></div>
        <div class="input-area">
          <input type="text" placeholder="Type your message...">
          <button onclick="promptImageURL(this)" title="Insert Image">
            <i class="fas fa-image"></i>
          </button>
          <button onclick="sendGroupMessage(this)">Send</button>
        </div>
      `;
      if (isVerifiedABen || isVerifiedLizzyBen) {
        chatWindow.querySelector('.refresh-btn').classList.add('visible');
      }
      document.getElementById('chatWindows').appendChild(chatWindow);
      activeChats.push({
        type: 'group',
        room: room,
        roomKey: room.key
      });
      loadGroupMessages(chatWindow.querySelector('.messages'), room.name);
    }
    
    function joinPrivateRoom() {
      const password = document.getElementById('joinPasswordInput').value;
      if (password === 'palmcoco' || password === currentRoom.password) {
        if (activeChats.length >= MAX_CHATS) {
          alert('Maximum number of chats reached!');
          return;
        }
        const chatWindow = document.createElement('div');
        chatWindow.className = 'chat-window';
        chatWindow.innerHTML = `
          <button class="close-window" onclick="closeChatWindow(this)">×</button>
          <div class="chat-header">
            <h2>${currentRoom.name}</h2>
          </div>
          <div class="messages"></div>
          <div class="input-area">
            <input type="text" placeholder="Type your message...">
            <button onclick="sendGroupMessage(this)">Send</button>
          </div>
        `;
        document.getElementById('chatWindows').appendChild(chatWindow);
        activeChats.push({
          type: 'group',
          room: currentRoom,
          roomKey: currentRoom.key
        });
        loadGroupMessages(chatWindow.querySelector('.messages'), currentRoom.name);
        joinPrivateModal.style.display = 'none';
      } else {
        alert('Incorrect password!');
      }
    }
    
    function loadGroupMessages(messagesDiv, roomName) {
      database.ref('messages').orderByChild('room').equalTo(roomName).once('value')
        .then((snapshot) => {
          messagesDiv.innerHTML = '';
          snapshot.forEach((childSnapshot) => {
            const data = childSnapshot.val();
            data.key = childSnapshot.key;
            addMessageToChat(data, messagesDiv);
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    }
    
    function sendGroupMessage(button) {
      const chatWindow = button.closest('.chat-window');
      const input = chatWindow.querySelector('input');
      const message = input.value.trim();
      if (!message) return;
      if (message.length > MAX_MESSAGE_LENGTH) {
        alert(`Message must be ${MAX_MESSAGE_LENGTH} characters or less`);
        return;
      }
      if (checkSpam(username)) {
        return;
      }
      const chatIndex = Array.from(document.querySelectorAll('.chat-window')).indexOf(chatWindow);
      const chat = activeChats[chatIndex];
      const messageData = {
        username: username,
        message: message,
        room: chat.room.name,
        timestamp: Date.now()
      };
      if (chat.type === 'group') {
        database.ref('messages').push(messageData).then((ref) => {
          messageData.key = ref.key;
          addMessageToChat(messageData, chatWindow.querySelector('.messages'));
        });
      }
      input.value = '';
    }
    
    // New functions for image insertion and display
    function promptImageURL(button) {
      currentChatWindowForImage = button.closest('.chat-window');
      document.getElementById('imageModal').style.display = 'flex';
    }
    function hideImageModal() {
      document.getElementById('imageModal').style.display = 'none';
      document.getElementById('imageURLInput').value = '';
    }
    function sendImageMessage() {
      const imageUrl = document.getElementById('imageURLInput').value.trim();
      if (!imageUrl) {
        alert("Please enter an image URL.");
        return;
      }
      if (imageUrl.length > 500) {
        alert("Image URL is too long. Please enter a valid image link.");
        return;
      }
      try {
        new URL(imageUrl);
      } catch (e) {
        alert("Invalid URL. Please enter a valid image link.");
        return;
      }
      const chatWindow = currentChatWindowForImage;
      if (!chatWindow) {
        alert("Chat window not found.");
        hideImageModal();
        return;
      }
      const chatIndex = Array.from(document.querySelectorAll('.chat-window')).indexOf(chatWindow);
      const chat = activeChats[chatIndex];
      if (!chat) {
        alert("Chat not found.");
        hideImageModal();
        return;
      }
      const messageData = {
        username: username,
        image: imageUrl,
        message: '',
        timestamp: Date.now()
      };
      if (chat.type === 'group') {
        messageData.room = chat.room.name;
        database.ref('messages').push(messageData).then((ref) => {
          messageData.key = ref.key;
          addMessageToChat(messageData, chatWindow.querySelector('.messages'));
          hideImageModal();
        });
      } else if (chat.type === 'dm') {
        database.ref('dmMessages').child(chat.dmId).push(messageData).then((ref) => {
          messageData.key = ref.key;
          addMessageToChat(messageData, chatWindow.querySelector('.messages'));
          database.ref('dms').child(chat.dmId).update({
            lastMessage: '[Image]',
            lastMessageTime: Date.now()
          });
          hideImageModal();
        });
      }
    }
    
    function addMessageToChat(data, messagesDiv = messages) {
      const messageElement = document.createElement('div');
      messageElement.className = `message ${data.username === username ? 'sent' : 'received'}`;
      messageElement.setAttribute('data-message-key', data.key || '');
      const verifiedBadge = (data.username === 'ABen' || data.username === 'LizzyBen')
        ? '<i class="fas fa-check-circle verified-badge"></i>'
        : '';
      const date = new Date(data.timestamp);
      const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const deleteButton = (isVerifiedABen || isVerifiedLizzyBen)
        ? `<span class="delete-btn" onclick="deleteMessage('${data.key || ''}')"><i class="fas fa-trash"></i></span>`
        : '';
      const checkbox = (isVerifiedABen || isVerifiedLizzyBen)
        ? `<input type="checkbox" class="message-checkbox" onchange="toggleMessageSelection('${data.key || ''}')">`
        : '';
      const reportButton = !(isVerifiedABen || isVerifiedLizzyBen)
        ? `<span class="report-btn" onclick="reportMessage('${data.key || ''}', '${data.username}', '${data.message}')"><i class="fas fa-flag"></i></span>`
        : '';
      let content = data.message;
      if (data.image) {
        content = `
          <div class="image-wrapper">
            <img src="${data.image}" alt="Image" style="max-width:100%; filter: blur(50px); transition: filter 0.3s;" />
            <button onclick="toggleImageBlur(this)">Show Image</button>
          </div>
        `;
      }
      messageElement.innerHTML = `
        ${checkbox}
        <div class="message-username">
          <span>
            ${data.username}
            ${verifiedBadge}
            ${reportButton}
          </span>
          <span class="message-time">${timeString}</span>
        </div>
        <div class="message-content">
          ${content}
          ${deleteButton}
        </div>
      `;
      messagesDiv.appendChild(messageElement);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function toggleImageBlur(btn) {
      const wrapper = btn.parentElement;
      const img = wrapper.querySelector('img');
      if (img.style.filter === 'blur(50px)') {
        img.style.filter = 'none';
        btn.textContent = 'Hide Image';
      } else {
        img.style.filter = 'blur(50px)';
        btn.textContent = 'Show Image';
      }
    }
    
    let activeChats = [];
    const MAX_CHATS = 4;
    const MIN_CHATS = 0;
    
    function closeChatWindow(button) {
      if (activeChats.length <= MIN_CHATS) {
        alert('You must keep at least one chat window open!');
        return;
      }
      const chatWindow = button.closest('.chat-window');
      const index = Array.from(document.querySelectorAll('.chat-window')).indexOf(chatWindow);
      activeChats.splice(index, 1);
      chatWindow.remove();
    }
    
    function toggleTheme() {
      isDarkMode = !isDarkMode;
      localStorage.setItem('darkMode', isDarkMode);
      document.body.classList.toggle('dark-mode', isDarkMode);
      const themeSwitch = document.querySelector('.theme-switch');
      themeSwitch.textContent = isDarkMode ? '☀️' : '🌙';
    }
    
    function signOut() {
      localStorage.removeItem('username');
      localStorage.removeItem('isVerifiedABen');
      localStorage.removeItem('isVerifiedLizzyBen');
      window.location.reload();
    }
    
    function filterRooms(query) {
      if (query.length > MAX_SEARCH_LENGTH) {
        query = query.substring(0, MAX_SEARCH_LENGTH);
      }
      const rooms = document.querySelectorAll('.room-item');
      rooms.forEach(room => {
        const roomName = room.querySelector('span').textContent.toLowerCase();
        room.style.display = roomName.includes(query.toLowerCase()) ? 'flex' : 'none';
      });
    }
    
    function checkSpam(username) {
      return false;
    }
    
    document.body.classList.toggle('dark-mode', isDarkMode);
    const themeSwitch = document.querySelector('.theme-switch');
    themeSwitch.textContent = isDarkMode ? '☀️' : '🌙';
    
    window.onload = function() {
      const savedUsername = localStorage.getItem('username');
      if (savedUsername) {
        username = savedUsername;
        loadRooms();
      } else {
        usernameModal.style.display = 'flex';
      }
    };
  </script>
</body>
</html>